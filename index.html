<html>
   <head>
      <title>Marvel Chronology</title>
      <style>
html, body {
   height: 100%;
   padding: 0;
   margin: 0;
   overflow: hidden;
}
#divToolBar {
   position: absolute;
   top: 0px;
   left: 0px;
   height: 50px;
   width: 100%;
   border: 0;
   overflow: hidden;
}
#divNavBar {
   position: absolute;
   top: 50px;
   left: 0px;
   width: 190px;
   height: 100%;
}
#divAppArea {
   position: absolute;
   top: 50px;
   left: 191px;
   width: 100%;
   height: 100%;
   border: 1;
}
#fraToolBar{
   width: 100%;
}
#fraNavBar{
   height: 100%;
   width: 190px;
}
#fraAppArea{
   height: 100%;
   width: 100%;
}
   </style>
   <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
   <script>
   const queryString = window.location.search;
   const urlParams = new URLSearchParams(queryString);
   var dc = (urlParams.get('PUB') == "DC")

   var access_token = "";
   var CLIENT_ID = '6blxv6kb9rkek2e';

   function isAuthenticated() {
      access_token = GetURLParameter('access_token');

      return (access_token != undefined && access_token.length > 0);
   }

   function authenticatePage() {
      if (isAuthenticated()) {
         resizeMainFrames();
      } else {
         var pubQueryString = "";
         if (dc) pubQueryString = "?PUB=DC";
         var dbx = new Dropbox.Dropbox({ clientId: CLIENT_ID });
         var authUrl = dbx.auth.getAuthenticationUrl('https://prowler22.github.io/index.html' + pubQueryString)
           .then((authUrl) => {
              window.location = authUrl;
           })
      }
   }
   
   function readFile(filename) {
      var dbx = new Dropbox.Dropbox({accessToken: access_token});

      dbx.filesListFolder({path: ''})
         .then(function(response) {
            var found = false;
            for (var i = 0; i < response.result.entries.length; i++) {
               if (response.result.entries[i].name == filename) {
                  found = true;
                  break;
               }
            }

            if (found) {
               dbx.filesDownload({path: '/' + filename})
                  .then(function (response) {
                     var blob = response.result.fileBlob;
                     var reader = new FileReader();
                     reader.addEventListener("loadend", function() {
                        window.fraAppArea.loadFile(reader.result);
                     });
                     reader.readAsText(blob);
                  })
                  .catch(function (error) {
                  })
            } else {
                window.fraAppArea.showData();
            }
        })
        .catch(function(error) {
          console.error(error);
        });
   }

    function writeFile(filename, fileContents) {
      var dbx = new Dropbox.Dropbox({ accessToken: access_token });

      dbx.filesUpload({path: '/' + filename, contents: fileContents, mode: 'overwrite'})
          .then(function(response) {
             alert('Progress saved!');
          })
          .catch(function(error) {
             alert('Error saving progress!\n' + error);
          });
    }

   function GetURLParameter(sParam) {
      var sPageURL = window.location.hash.substring(1);

      var sURLVariables = sPageURL.split('&');
      for (var i = 0; i < sURLVariables.length; i++) {
         var sParameterName = sURLVariables[i].split('=');
         if (sParameterName[0] == sParam) {
            return sParameterName[1];
         }
      }

      return "";
   }

   function resizeMainFrames() {
      var newHeight = document.body.clientHeight - document.getElementById('divToolBar').clientHeight;
      document.getElementById('divNavBar').style.height = newHeight + "px";
      document.getElementById('divAppArea').style.height = newHeight + "px";
      document.getElementById('divAppArea').style.width = (document.body.clientWidth - document.getElementById('divNavBar').clientWidth - 4) + "px";
   }
   </script>
   </head>
   <body onload="authenticatePage()" onresize="resizeMainFrames()">
       <div id="divToolBar">
           <iframe id="fraToolBar" name="fraToolBar" src="toolbar.html" scrolling="no" frameborder="0"></iframe>
       </div>
       <div id="divNavBar">
           <iframe id="fraNavBar" name="fraNavBar" src="navbar.html" frameborder="0"></iframe>
       </div>
       <div id="divAppArea">
           <iframe id="fraAppArea" name="fraAppArea"></iframe>
       </div>
   </body>
</html>